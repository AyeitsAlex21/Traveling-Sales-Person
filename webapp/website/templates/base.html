<!-- Source Code for the UI of the web app, NASAK, CIS422 FA21
Author(s): Anna Nguyen, Kale Satta-Hutton
Last Edited: 10/31/21
Description: This template renders an embeded google map with a search bar to
look up locations to add to a route. Users can also delete locations. Once all
locations are inputted, users can select to calculate the optimal path. The
page will then pass the user inputted data to be processed in the Genetic 
Algorithm and render a new map with routes displayed using Google Maps API
DirectionService.
Sources:
	https://developers.google.com/maps/documentation/embed/get-started
	https://developers.google.com/maps/documentation/javascript/examples/places-placeid-finder#maps_places_placeid_finder-javascript
	https://developers.google.com/maps/documentation/places/web-service/place-id
	https://developers.google.com/maps/documentation/javascript/directions
     -->

<!doctype html>
<html lang="en">

<!-- Library to pass user data into the Flask App -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
</script>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>Landing Page</title>
	<style>
		/* CSS Styling
			Always set the map height explicitly to define the size of the div
		    element that contains the map.
		*/
		#map {
			height: 100%;
		}

		/* Fills map to fit window */
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
			font-family: Roboto;
		}

		#button {
			display: inline-block;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 500;
			background: white;
			color: #444;
			width: 190px;
			border-radius: 5px;
			border: thin solid #888;
			box-shadow: 1px 1px 1px grey;
			white-space: nowrap;
		}

		#description {
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
		}

		#infowindow-content .title {
			font-weight: bold;
		}

		#infowindow-content {
			display: none;
		}

		#map #infowindow-content {
			display: inline;
		}

		#searchTextField {
			background-color: #fff;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
			margin-left: 12px;
			padding: 0 11px 0 13px;
			text-overflow: ellipsis;
			width: 400px;
		}

		#searchTextField:focus {
			border-color: #4d90fe;
		}

		#title {
			color: #fff;
			background-color: #4d90fe;
			font-size: 25px;
			font-weight: 500;
			padding: 6px 12px;
		}

		#target {
			width: 345px;
		}
	</style>
</head>

<body>
	<!-- Displays Add Location and Calculate Path button controls -->
	<div style="width:1000px;" id="bar">
		<button id="button" onClick="addLocation()" class="controls">Add Location</button>
		<button id="button" onClick="minPath()" class="controls">Calculate Path</button>

		<!-- Where currently added locations will display -->
		<p id="locationDisplay"></p>
	</div>

	<!-- Search Bar to look up locations to add -->
	<input id="searchTextField" class="controls" type="text" placeholder="Search Box" />

	<!-- Embeded Google Map -->
	<div id="map"></div>

	<script type=text/javascript>
		var locations = []; // Array of locations to pass to the Flask App
		var title, position; // Location title and position to be passed into array of locations
		var markers = []; // Marker array to display markers ion map
		var locationsLength = 0;
		var map; // Embeded Google Map

		function initialize() {
			// Initializes google map and map controls
			map = new google.maps.Map(document.getElementById('map'), {
				center: { lat: -33.8688, lng: 151.2195 },
				zoom: 13,
				mapTypeId: 'roadmap'
			});

			// Creates a search bar and link it to the UI componment
			var input = document.getElementById('searchTextField');
			var autocomplete = new google.maps.places.SearchBox(input);
			map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

			// Moves map viewpoint to result of the serach bar
			map.addListener('bounds_changed', function () {
				autocomplete.setBounds(map.getBounds());
			});
			// Listen for the event fired when the user selects a prediction and retrieve
			// more details for that place.
			autocomplete.addListener('places_changed', function () {
				var places = autocomplete.getPlaces();

				if (places.length == 0) {
					return;
				}

				// For each place, get the icon, name and location
				var bounds = new google.maps.LatLngBounds();
				places.forEach(function (place) {
					title = place.name;
					position = place.geometry.location;
					place_id = place.place_id
					if (!place.geometry) {

						console.log("Returned place contains no geometry");
						return;
					}

					if (place.geometry.viewport) {
						bounds.union(place.geometry.viewport);
					} else {
						bounds.extend(place.geometry.location);
					}
				});
				map.fitBounds(bounds);
			});
		}
		function addLocation() { // Function that will add markers on button click
			// Initialize marker icon
			var icon = {
				url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
				size: new google.maps.Size(71, 71),
				origin: new google.maps.Point(0, 0),
				anchor: new google.maps.Point(17, 34),
				scaledSize: new google.maps.Size(25, 25)
			};

			// Create a new marker 
			markers.push(new google.maps.Marker({
				map: map,
				icon: icon,
				title: title,
				position: position,
				animation: google.maps.Animation.DROP
			}));

			// Initialize and add location to locationsay
			var location = {
				title: title,
				position: position,
				place_id: place_id
			}

			// Add location to location array
			locations.push(location);
			locationsLength++;

			// Display list of locations on UI
        	displayList(locations);

			console.log(JSON.stringify(locations))
		}

		function displayList(locations) { // Loops through array of locations and displays dynamic list with delete button
			LLen = locations.length; // Declare location array length

			text = "<ul>";
			for (i = 0; i < LLen; i++) {
				text += "<li>" + locations[i].title + "<input type='button' id='button' onclick='deleteLocation(" + i + ")' value='Delete' /></li>";
			}
			text += "</ul>";

			// Update locationDisplay in UI with dynamic array
			document.getElementById("locationDisplay").innerHTML = text;
    	}

		function deleteLocation(index) { // Removes selected location element from location array and marker from map/array
			locationsLength--;

			locations.splice(index, 1); // Delete location from array
			displayList(locations); // Update dynamic array
			markers[index].setMap(null); // Remove marker form map
			markers.splice(index, 1); // Remove marker from marker array
			console.log(JSON.stringify(locations))
		}

		function minPath() {
			$.getJSON('/_min_path', {vals: JSON.stringify(locations)}).done(
				function(data) {
					var places = data.ret;
					var path = [];
					for (id in places) {
						let len = locations.length;
						for (let i = 0; i < len; i++) {
							if (places[id] == locations[i].place_id) {
									path.push(locations[i].position);
							}
						}
					}
					var directionsService = new google.maps.DirectionsService();
  					var directionsRenderer = new google.maps.DirectionsRenderer();
					directionsRenderer.setMap(map);
					let len = path.length;
					directions = [];
					waypoints = [];
					for (let i = 1; i < len; i++) {
						waypoints.push({
							location: path[i],
							stopover: true,
						});
					}
					directionsService.route({
				      origin: path[0],
				      destination: path[0],
				      waypoints: waypoints,
				      optimizeWaypoints: false,
				      travelMode: google.maps.TravelMode.DRIVING,
				    })
				    .then((response) => {
				      directionsRenderer.setDirections(response);
						})
				}
			).fail(function(err){
				console.log("Erorr!");
				console.log(err);
			});
		}

	</script>
	<!-- Set the Maps Embed API URL as the src attribute -->
	<script 
		src="https://maps.googleapis.com/maps/api/js?key=API_KEY&libraries=places&callback=initialize"
		async defer></script>

	<form>
	</form>

</body>
</html>