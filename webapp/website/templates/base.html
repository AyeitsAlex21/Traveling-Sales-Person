<!doctype html>
<html lang="en">

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
</script>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<title>Landing Page</title>
	<style>
		/* Always set the map height explicitly to define the size of the div
		   * element that contains the map. */
		#map {
			height: 100%;
		}

		/* Optional: Makes the sample page fill the window. */
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#drop {
			display: inline-block;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 500;
			background: white;
			color: #444;
			width: 190px;
			border-radius: 5px;
			border: thin solid #888;
			box-shadow: 1px 1px 1px grey;
			white-space: nowrap;
		}

		#description {
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
		}

		#infowindow-content .title {
			font-weight: bold;
		}

		#infowindow-content {
			display: none;
		}

		#map #infowindow-content {
			display: inline;
		}

		#searchTextField {
			background-color: #fff;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
			margin-left: 12px;
			padding: 0 11px 0 13px;
			text-overflow: ellipsis;
			width: 400px;
		}

		#searchTextField:focus {
			border-color: #4d90fe;
		}

		#title {
			color: #fff;
			background-color: #4d90fe;
			font-size: 25px;
			font-weight: 500;
			padding: 6px 12px;
		}

		#target {
			width: 345px;
		}
	</style>
</head>

<body>
	<div style="width:1000px;" id="bar">
		<button id="drop" onClick="addMyMarker()" class="controls">Add Location</button>
		<button id="drop" onClick="minPath()" class="controls">Calculate Path</button>
		<p id="LargeInventory"></p>
	</div>
	<input id="searchTextField" class="controls" type="text" placeholder="Search Box" />
	<div id="map"></div>

	<script type=text/javascript>
		var LargeList = [];
		var title, position;
		var markers = [];
		var locationsLength = 0;
		var map;
		var locations = [];
		function initialize() {
			map = new google.maps.Map(document.getElementById('map'), {
				center: { lat: -33.8688, lng: 151.2195 },
				zoom: 13,
				mapTypeId: 'roadmap'
			});

			// Create the search box and link it to the UI element.
			var input = document.getElementById('searchTextField');
			var autocomplete = new google.maps.places.SearchBox(input);
			map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

			// Bias the SearchBox results towards current map's viewport.
			map.addListener('bounds_changed', function () {
				autocomplete.setBounds(map.getBounds());
			});
			// Listen for the event fired when the user selects a prediction and retrieve
			// more details for that place.
			autocomplete.addListener('places_changed', function () {
				var places = autocomplete.getPlaces();

				if (places.length == 0) {
					return;
				}

				// For each place, get the icon, name and location.
				var bounds = new google.maps.LatLngBounds();
				places.forEach(function (place) {
					title = place.name;
					position = place.geometry.location;
					place_id = place.place_id
					if (!place.geometry) {

						console.log("Returned place contains no geometry");
						return;
					}

					if (place.geometry.viewport) {
						// Only geocodes have viewport.
						bounds.union(place.geometry.viewport);
					} else {
						bounds.extend(place.geometry.location);
					}
				});
				map.fitBounds(bounds);
			});
		}
		function addMyMarker() { //function that will add markers on button click
			var icon = {
				url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
				size: new google.maps.Size(71, 71),
				origin: new google.maps.Point(0, 0),
				anchor: new google.maps.Point(17, 34),
				scaledSize: new google.maps.Size(25, 25)
			};

			// Create a marker for each place.
			markers.push(new google.maps.Marker({
				map: map,
				icon: icon,
				title: title,
				position: position,
				animation: google.maps.Animation.DROP
			}));
			var location = {
				title: title,
				position: position,
				place_id: place_id
			}
			locations.push(location);
			locationsLength++;
			//
			LargeList.push(title);

        	PopulateList(LargeList);
			//
			for (var i = 0; i < locationsLength; i++) {console.log(JSON.stringify(locations)) }
		}

		function PopulateList(arr) {
			LLen = arr.length;

			text = "<ul>";
			for (i = 0; i < LLen; i++) {
				text += "<li>" + arr[i] + "<input type='button' onclick='Delitem(" + i + ")' value='Delete' /></li>";
			}
			text += "</ul>";

			document.getElementById("LargeInventory").innerHTML = text;
    	}
		function Delitem(index) {
			locationsLength--;
			LargeList.splice(index, 1);
			locations.splice(index, 1);
			PopulateList(LargeList);
			markers[index].setMap(null);
			markers.splice(index, 1);
			console.log(JSON.stringify(locations))
		}

		function minPath() {
			$.getJSON('/_min_path', {vals: JSON.stringify(locations)}).done(
				function(data) {
					var places = data.ret;
					var path = [];
					for (id in places) {
						let len = locations.length;
						for (let i = 0; i < len; i++) {
							if (places[id] == locations[i].place_id) {
									path.push(locations[i].position);
							}
						}
					}
					var directionsService = new google.maps.DirectionsService();
  					var directionsRenderer = new google.maps.DirectionsRenderer();
					directionsRenderer.setMap(map);
					let len = path.length;
					directions = [];
					waypoints = [];
					for (let i = 1; i < len; i++) {
						waypoints.push({
							location: path[i],
							stopover: true,
						});
					}
					directionsService.route({
				      origin: path[0],
				      destination: path[0],
				      waypoints: waypoints,
				      optimizeWaypoints: false,
				      travelMode: google.maps.TravelMode.DRIVING,
				    })
				    .then((response) => {
				      directionsRenderer.setDirections(response);
						})
				}
			).fail(function(err){
				console.log("Erorr!");
				console.log(err);
			});
		}

	</script>
	<script
		src="https://maps.googleapis.com/maps/api/js?key=API_KEY&libraries=places&callback=initialize"
		async defer></script>

	<form>
	</form>

</body>

</html>